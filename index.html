<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop Information</title>
    <link rel="stylesheet" type="text/css" href="assets/style.css">
  </head>

  <body>

    <div id="logo">
        <!-- Hier kann das Logo eingefügt werden -->
        <img src="assets/logo.png" alt="Logo">
    </div>
    <div id="output-container-metadata"></div>
    <div id="output-container"></div>

    <script>
   async function fetchData() {
        try {
            // Hier kann der Pfad zur output.json-Datei eingefügt werden
            const response = await fetch('output.json');
            const data = await response.json();
            displayData(data.shops);
            displayLatestFileModDate(data.meta.latestfilemoddate_formatted);
        } catch (error) {
            console.error('Fehler beim Abrufen der Daten:', error);
        }
    }

    function displayLatestFileModDate(date) {
        const latestFileModDateElement = document.getElementById('output-container-metadata');
        latestFileModDateElement.textContent = `Latest Data: ${date}`;
    }

    async function displayData(shops) {
        const outputContainer = document.getElementById('output-container');

        if (Array.isArray(shops)) {
            for (const shop of shops) {
                // Shop-Container
                const shopContainer = document.createElement('div');
                shopContainer.classList.add('shop-container');

                // Shop-Name und Besitzerinformationen
                const shopInfo = document.createElement('div');
                shopInfo.classList.add('shop-info');
                shopInfo.textContent = `Shop: ${shop.shop_name} - Owner: ${shop.owner_name}`;
                shopContainer.appendChild(shopInfo);

                // Verkaufstabelle
                const sellTableContainer = document.createElement('div');
                sellTableContainer.classList.add('table-container');
                sellTableContainer.innerHTML = '<h2>Selling</h2>';
                const sellTable = document.createElement('table');
                await setupTable(sellTable, shop.offers, false);
                sellTableContainer.appendChild(sellTable);

                // Ankaufstabelle
                const buyTableContainer = document.createElement('div');
                buyTableContainer.classList.add('table-container');
                buyTableContainer.innerHTML = '<h2>Buying</h2>';
                const buyTable = document.createElement('table');
                await setupTable(buyTable, shop.demands, false);
                buyTableContainer.appendChild(buyTable);

                shopContainer.appendChild(sellTableContainer);
                shopContainer.appendChild(buyTableContainer);
                outputContainer.appendChild(shopContainer);
            }
        } else {
            console.error('Ungültiges Datenformat:', shops);
        }
    }
	
    // Funktion zum Einrichten der Tabelle
    async function setupTable(table, items, isBuyTable) {
        // Tabellenkopf
        const headerRow = table.insertRow();
        const headers = ['Item', 'Menge', 'Preis', 'Stückpreis', 'Bestand'];
        headers.forEach(headerText => {
            const header = document.createElement('th');
            header.textContent = headerText;
            headerRow.appendChild(header);
        });

        // Elemente
        for (const itemKey in items) {
            const item = items[itemKey];
            if ((isBuyTable && item.price < 0) || (!isBuyTable && item.price >= 0)) {
                const row = table.insertRow();

                // Elementname
                const itemNameCell = row.insertCell();
                const translatedName = await getTranslation(item.own_name || item.item);
                itemNameCell.textContent = translatedName;

                // Menge
                const amountCell = row.insertCell();
                amountCell.textContent = item.amount;

                // Preis
                const priceCell = row.insertCell();
                const price = item.price_discount === 0 ? item.price : item.price - (item.price * (item.price_discount / 100));
                priceCell.textContent = price;

                // Stückpreis
                const unitPriceCell = row.insertCell();
                unitPriceCell.textContent = item.unit_price;

                // Bestand
                const stockCell = row.insertCell();
                stockCell.textContent = item.stock === 0 ? 'Sold out' : item.stock;
                if (item.stock < 5) {
                    stockCell.classList.add('low-stock');
                }
            }
        }
    }

    // Funktion zur Übersetzung
    async function getTranslation(text) {
        // Hier kann die Logik für die Übersetzung implementiert werden
        // Beispiel: Text wird direkt zurückgegeben (kann durch ein API-Aufruf ersetzt werden)
        return text;
    }

    // fetchData bei Seitenladung ausführen
    fetchData();
    </script>
  </body>
</html>